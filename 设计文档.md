# 三、设计文档（Design）

下面是供后端 + 前端一起看的设计说明。

---

## 3.1 总体架构

* **前端 (React)**

  * React + React Router
  * HTTP 客户端：fetch 或 axios
  * 负责：

    * 搜索参数表单
    * 结果展示
    * 收藏/取消收藏操作
    * 本地收藏列表/详情展示

* **后端 (FastAPI 示例)**

  * 路由层：`/api/arxiv/search`, `/api/papers/...`
  * Service 层：调用 `arxiv_client.search_arxiv`、操作 MySQL
  * DAO / Repository 层：对 MySQL 的 CRUD
  * DB：MySQL，使用 SQLAlchemy（或其他 ORM）

---

## 3.2 数据库设计（MySQL Schema）

### 3.2.1 表：`papers`（存 arXiv 论文基础信息）

```sql
CREATE TABLE papers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    arxiv_id VARCHAR(32) NOT NULL UNIQUE,    -- 例如: 2506.05176
    version VARCHAR(16) NULL,                -- 例如: v3
    title TEXT NOT NULL,
    summary MEDIUMTEXT NULL,
    authors TEXT NULL,                       -- 存 JSON 字符串: ["A", "B", ...]
    primary_category VARCHAR(64) NULL,
    categories TEXT NULL,                    -- JSON: ["cs.LG", "cs.AI"]
    published DATETIME NULL,
    updated DATETIME NULL,
    pdf_url VARCHAR(512) NULL,
    abs_url VARCHAR(512) NULL,
    doi VARCHAR(128) NULL,
    journal_ref VARCHAR(512) NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

> 说明：
>
> * `authors`、`categories` 等用 JSON 字符串存（后端读写时 `json.dumps/loads`）。
> * 未来如需复杂作者搜索，可拆成关联表，这里先简化。

---

### 3.2.2 表：`saved_papers`（用户的收藏记录）

```sql
CREATE TABLE saved_papers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    paper_id BIGINT NOT NULL,
    -- 未来有多用户时增加 user_id 外键
    tags VARCHAR(512) NULL,                 -- 以逗号分隔，或 JSON 数组字符串
    note TEXT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT fk_saved_papers_paper
        FOREIGN KEY (paper_id) REFERENCES papers(id)
        ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

> 在单用户场景中，可以假设所有 `saved_papers` 都属于同一人。如将来支持多用户，再加 `user_id`。

---

### 3.2.3 表：`search_logs`（可选）

简单记录搜索行为，方便排查线下问题：

```sql
CREATE TABLE search_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    query_json TEXT NOT NULL,
    result_count INT NOT NULL,
    status VARCHAR(32) NOT NULL,            -- success / error
    error_message TEXT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 3.3 后端接口设计

### 3.3.1 POST `/api/arxiv/search`

**功能**：接收前端检索参数，调用 `arxiv_client.search_arxiv`，将结果返回给前端（不必全部写入本地数据库）。

**Request Body（JSON）**：

```json
{
  "all_terms": "large language model",
  "title": null,
  "abstract": null,
  "author": null,
  "categories": ["cs.LG", "cs.AI"],
  "date_mode": "submitted",
  "date_from": "2024-01-01",
  "date_to": null,
  "sort_by": "submittedDate",
  "sort_order": "descending",
  "max_results": 20,
  "id_list": null
}
```

字段含义与前面 JSON Schema 一致。

**Response 200（JSON）**：

```json
{
  "items": [
    {
      "arxiv_id": "2506.05176",
      "version": "v3",
      "title": "...",
      "summary": "...",
      "authors": ["A", "B"],
      "primary_category": "cs.LG",
      "categories": ["cs.LG"],
      "published": "2025-06-01T10:20:30",
      "updated": "2025-06-10T11:22:33",
      "pdf_url": "https://arxiv.org/pdf/2506.05176v3.pdf",
      "abs_url": "https://arxiv.org/abs/2506.05176v3",
      "doi": null,
      "journal_ref": null
    }
  ]
}
```

**错误处理**：

* arXiv 网络错误 / 限流：

  * 返回 502 / 503，body 中包含简洁错误信息。
  * 在 `search_logs` 中记录错误。

---

### 3.3.2 POST `/api/papers/save`

**功能**：收藏一篇论文到本地库。

**Request Body**：

```json
{
  "paper": {
    "arxiv_id": "2506.05176",
    "version": "v3",
    "title": "...",
    "summary": "...",
    "authors": ["A", "B"],
    "primary_category": "cs.LG",
    "categories": ["cs.LG"],
    "published": "2025-06-01T10:20:30",
    "updated": "2025-06-10T11:22:33",
    "pdf_url": "https://arxiv.org/pdf/2506.05176v3.pdf",
    "abs_url": "https://arxiv.org/abs/2506.05176v3",
    "doi": null,
    "journal_ref": null
  },
  "tags": "llm, long context",
  "note": "和当前项目比较相关"
}
```

**后端逻辑**：

6. 根据 `arxiv_id` 查询 `papers` 表：

   * 若不存在：

     * 插入一条新的 `papers` 记录。
   * 若存在：

     * 更新字段（可覆盖 title/summary/published/updated 等）。
7. 在 `saved_papers` 中创建记录：

   * 如果已存在该 `paper_id` 的记录，可选择：

     * 更新 `tags` & `note` & `updated_at`，不新建。
8. 返回 `saved_papers` 的完整信息（含 `paper` 基本信息）。

**Response 200**：

```json
{
  "id": 123,
  "paper_id": 45,
  "tags": "llm, long context",
  "note": "和当前项目比较相关",
  "created_at": "2025-11-27T01:23:45",
  "updated_at": "2025-11-27T01:23:45"
}
```

---

### 3.3.3 GET `/api/papers/saved`

**功能**：获取本地收藏列表（支持过滤和分页）。

**Query 参数示例**：

* `page`: 页码，从 1 开始
* `page_size`: 每页条数，建议 10–50
* `keyword`: 标题/摘要关键词（简单 LIKE）
* `author`: 作者关键词（对 `authors` JSON 做 LIKE 或后续优化）
* `category`: 单一分类过滤
* `tag`: 按标签过滤

**Response 200**：

```json
{
  "items": [
    {
      "saved_id": 123,
      "tags": "llm, long context",
      "note": "和当前项目比较相关",
      "created_at": "2025-11-27T01:23:45",
      "updated_at": "2025-11-27T01:23:45",
      "paper": {
        "id": 45,
        "arxiv_id": "2506.05176",
        "version": "v3",
        "title": "...",
        "authors": ["A", "B"],
        "primary_category": "cs.LG",
        "categories": ["cs.LG"],
        "published": "2025-06-01T10:20:30",
        "updated": "2025-06-10T11:22:33",
        "pdf_url": "https://arxiv.org/pdf/2506.05176v3.pdf",
        "abs_url": "https://arxiv.org/abs/2506.05176v3",
        "doi": null,
        "journal_ref": null
      }
    }
  ],
  "page": 1,
  "page_size": 10,
  "total": 42
}
```

---

### 3.3.4 GET `/api/papers/{saved_id}`

**功能**：获取某条收藏的详细信息（用于详情页编辑）。

**Response 200**：

同上 `items[0]` 的结构。

---

### 3.3.5 PATCH `/api/papers/{saved_id}`

**功能**：更新收藏记录的 `tags` & `note`。

**Request Body**：

```json
{
  "tags": "llm, arxiv, important",
  "note": "重点阅读"
}
```

---

### 3.3.6 DELETE `/api/papers/{saved_id}`

**功能**：取消收藏/删除本地记录。

返回 204 无内容或 200 基本信息均可。

---

## 3.4 前端页面与组件设计

### 3.4.1 路由结构（建议）

* `/search`：arXiv 在线检索页（默认首页）
* `/saved`：本地收藏列表页
* `/papers/:savedId`：收藏详情页（可选）

---

### 3.4.2 页面：SearchPage（/search）

**布局**：

9. 左侧/顶部：搜索表单（`SearchForm`）
10. 下方：结果列表（`SearchResultList`）

**SearchForm 表单字段**（对应 API）：

* 文本输入：

  * `all_terms`（「关键词（全文）」）
  * `title`（「标题包含」）
  * `abstract`（「摘要包含」）
  * `author`（「作者」）
* 分类选择：

  * `categories`：多选（可以直接用可编辑文本输入，如 `"cs.LG, cs.AI"`；或者硬编码常用分类的多选下拉）
* 时间范围：

  * `date_mode`：单选按钮：不限制 / 按提交时间 / 按更新时间
  * `date_from` / `date_to`：日期选择器（YYYY-MM-DD）
* 排序：

  * `sort_by`：下拉（相关度 / 提交时间 / 更新时间）
  * `sort_order`：下拉（降序 / 升序）
* 数量：

  * `max_results`：数字输入，1–50

**交互逻辑**：

* 用户点击「搜索」按钮：

  * 前端组装 JSON 请求体发送到 `/api/arxiv/search`
  * 展示 “Loading...” 状态
  * 成功 → 渲染结果列表
  * 失败 → 在顶部显示错误消息

---

### 3.4.3 组件：SearchResultList

* 接收 `results: ArxivPaper[]`

* 每条显示：

  * 标题（点击跳 arxiv abs 页面）
  * 作者
  * 分类
  * 发表/更新日期
  * 摘要前 300 字
  * 右下角两个按钮：

    * 「收藏」 → 调 `POST /api/papers/save`
    * 「详情」（可选） → 打开内部详情页或展开摘要

* 被收藏后可以：

  * 按钮状态变为「已收藏」
  * 或展示一个✅图标

---

### 3.4.4 页面：SavedPapersPage（/saved）

* 顶部：过滤条件（keyword, author, tag, category）
* 中部：收藏列表（分页）
* 每条展示：

  * 标题（点击内部详情页）
  * 作者、分类
  * 收藏时间
  * tags
  * 操作按钮：

    * 「编辑标注」（弹出对话框编辑 tags/note）
    * 「取消收藏」

---

### 3.4.5 页面：PaperDetailPage（/papers/:savedId）

* 展示前述 `paper` + `saved_papers` 的全部字段
* 提供：

  * 编辑 tags/note 表单 + 保存按钮（调用 PATCH）
  * 快捷打开 PDF/Arxiv 链接按钮

---

## 3.5 后端实现分层建议

你可以让 AI coder 按下面分层来写：

11. `arxiv_client.py`

   * 已有的 `ArxivSearchParams` + `search_arxiv`（不改或只做小改动）
12. `models.py`（SQLAlchemy ORM）

   * `Paper`、`SavedPaper`、`SearchLog`
13. `schemas.py`（Pydantic）

   * `ArxivSearchRequest`, `ArxivPaperDTO`, `SavedPaperDTO` 等
14. `repositories/`

   * `papers.py`：封装 `get_by_arxiv_id`, `create_or_update_from_arxiv`, `get_saved_list` 等
15. `routes/`

   * `routes_arxiv.py`：`/api/arxiv/search`
   * `routes_papers.py`：`/api/papers/...`

---

## 3.6 错误处理与边界情况

16. **arXiv 返回为空**

   * 前端展示「没有匹配结果」
17. **arXiv 超时/429**

   * 后端捕获异常，返回 502/503 + message
   * 前端展示「arXiv API 当前不可用，请稍后重试」
18. **收藏重复**

   * 再次点击收藏时，后端只更新标签/备注，不报错
   * 前端提示「已更新收藏信息」而不是「新建成功」
19. **数据库错误**

   * 后端返回 500，记录日志
   * 前端提示「服务器内部错误」
